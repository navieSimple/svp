桌面虚拟化协议大纲
=======

一. 什么是桌面虚拟化协议
----------

一种高性能，动态，自适应的远程呈现技术，能为终端用户带来和物理桌面个人计算机难以区分的体验。

二. 常见的桌面虚拟化协议
----------
- Citrix ICA/HDX (Xen)
- Microsoft RDP, RemoteFX (HyperV)
- Teradici PCOIP (VMware)
- HP RGS
- Redhat SPICE (RHEV)

三. 影响桌面虚拟化协议的因素
------------

好的协议: 低带宽, 低CPU占用率, 良好用户体验

影响因数:网络带宽, 服务器端与客户端计算能力, 网络延迟

无法同时满足这三个要求，就要采用动态(自适应)的手段来达到期望的效果。

### 1. 桌面传输中的常见对象

-   GDI/GDI+
-   WPF
-   Video/Audio
-   DirectX/OpenGL
-   Flash/Sliverlight

### 2. 什么是渲染

将图形由抽象表示转变成像素(位图)表示

#### 2.1 服务器端渲染

服务器端负责**渲染 捕获 压缩 加密**

客户端负责**解密 解压 显示**

#### 2.2 客户端渲染

服务器端负责**捕获 压缩 加密**

客户端负责**解密 解压 渲染 显示**

#### 3. 压缩

[图片]

四. 基本架构
----

### 1. 虚拟通道

虚拟机端<---->主机端<---->客户端通信,供虚拟机中驱动,应用程序使用。

#### 类型

-   GDI通道
-   键鼠事件通道
-   多媒体重定向通道
-   USB重定向通道
-   ...

#### 接口

-   虚拟机端
	-   打开通道
    -   从通道中读取数据
    -   向通道中写入数据
    -   参数设置(原子读写操作,即ioctl)
    -   关闭通道
-   主机端
    -   主机端<---->虚拟机端通道注册
    -   主机端<---->客户端通道注册

支持虚拟机中驱动,应用程序动态创建虚拟通道。

#### 实现

虚拟机端:提供用户空间和内核空间API

主机端

- 虚拟通道主机端插件框架
- 修改VRDE初始化部分,载入相应插件
- 接口API实现

客户端

- 接口API实现

### 2. GDI通道

###### GDI组成

- 基本绘图指令(点,线,多边形)
- 图像(位图)
- 文字(字体)

#### 实现方式

客户端渲染

##### 服务器端

**捕获**:VRDE

>   虚拟机操作系统中图形驱动----\>主机虚拟机共享内存接口(HGSMI)----\>主机VRDE扩展插件包

**压缩**:动态(自适应)图像压缩

>   冗余指令，被遮挡图像剔除

>   无损图像压缩算法

>   有损图像压缩算法

**加密**:无

##### 客户端

**解密**:无

**解压**:调用对应的算法

**渲染**:2D渲染,纯CPU画图片

### 3. 多媒体重定向通道

#### 目的

流畅播放虚拟机中本地媒体文件。

#### 实现方式

由于目前不打算引入硬件，因此采用客户端渲染手段：

1.  虚拟机端播放器创建两个到客户端的虚拟通道,用于传输数据与控制命令
2.  虚拟机端播放器传输播放,停止,跳转等命令到客户端
3.  客户端接受到相应控制命令,根据一个自定义的远程资源访问协议,发送相应命令到虚拟机端
4.  虚拟机端推送相应**解码前**的数据到客户端
5.  客户端接收数据，解码，渲染，上屏

##### 服务器端

**捕获**:虚拟机中的播放器知道要播放的媒体文件,及当前播放位置等信息

**压缩**:无

**加密**:无

##### 客户端

**解密**:无

**解压**:无

**渲染**:CPU解码,3D上屏显示
